<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sign-In Demo</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Google Sign-In Button -->
    <div id="g_id_onload"
         data-client_id="382027941440-35fmph7hti4d30rb5fcaposg1nvcltmt.apps.googleusercontent.com"
         data-context="signin"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>

    <!-- Display User Information -->
    <div id="user-info" style="margin-top: 20px;">
        <h2>User Information</h2>
        <p><strong>Name:</strong> <span id="user-name"></span></p>
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <img id="user-picture" alt="User Picture" style="display:none; width:100px; border-radius:50%;">
    </div>

    <script>
        async function handleCredentialResponse(response) {
    try {
        const idToken = response.credential;
        const payload = JSON.parse(atob(idToken.split(".")[1]));

        const userData = {
            name: payload.name,
            email: payload.email,
            picture: payload.picture,
            credits: 100  // Set initial credits if it's a new user
        };

        console.log("Decoded Payload:", payload);
        console.log("Constructed User Data:", userData);

        // Send user info to the backend Netlify function
        const requestBody = JSON.stringify(userData);

        const res = await fetch("https://your-netlify-function-url", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: requestBody
        });

        const result = await res.json();

        if (!res.ok) {
            throw new Error(`Backend error - Status: ${res.status}, Message: ${result.message || "Unknown error"}`);
        }

        // Check if the user already exists
        if (result.userExists) {
            console.log("User data fetched successfully:", result);
            alert("User already exists. Data fetched successfully!");
        } else {
            console.log("New user created:", result);
            alert("New user created and data updated successfully!");
        }

        // Update the UI with user information
        document.getElementById("user-name").innerText = result.name;
        document.getElementById("user-email").innerText = result.email;
        const imgElement = document.getElementById("user-picture");
        imgElement.src = result.picture;
        imgElement.style.display = "block";

    } catch (error) {
        console.error("Error during credential handling:", error);
        alert(`Error: ${error.message}`);
    }
}

    </script>
</body>
</html>
